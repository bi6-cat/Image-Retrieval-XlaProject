<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Search - Animal Image Retrieval</title>
  <link rel="stylesheet" href="styles_improved.css">
  <style>
    .filters-container {
      max-width: 1000px;
      margin: 20px auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .filter-label {
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }
    
    .filter-select {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.3s;
    }
    
    .filter-select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #f0f0f0;
    }
    
    .filter-tag {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-tag .remove {
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: white;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="search-container" style="max-width: 1000px;">
    <a href="/" class="back-link">‚Üê Back to Simple Search</a>
    <h1 style="color: white; text-align: center;">üîç Advanced Search</h1>
    <p style="text-align: center; color: white; margin-bottom: 30px;">
      Use filters to find exactly what you're looking for
    </p>
  </div>

  <div class="filters-container">
    <h3>Search Query</h3>
    <input id="queryInput" type="text" placeholder="Enter your search query..." 
           style="width: 100%; padding: 14px 20px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; margin-bottom: 20px;">
    
    <h3 style="margin-top: 30px;">Filters</h3>
    <div class="filter-grid">
      <div class="filter-group">
        <label class="filter-label">üêæ Species</label>
        <select class="filter-select" id="speciesFilter">
          <option value="">All Species</option>
          <option value="cat">Cat</option>
          <option value="dog">Dog</option>
          <option value="bird">Bird</option>
          <option value="horse">Horse</option>
          <option value="cow">Cow</option>
          <option value="sheep">Sheep</option>
          <option value="elephant">Elephant</option>
          <option value="butterfly">Butterfly</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">üë∂ Age Group</label>
        <select class="filter-select" id="ageFilter">
          <option value="">Any Age</option>
          <option value="baby">Baby</option>
          <option value="young">Young</option>
          <option value="adult">Adult</option>
          <option value="elderly">Elderly</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">üé® Primary Color</label>
        <select class="filter-select" id="colorFilter">
          <option value="">Any Color</option>
          <option value="white">White</option>
          <option value="black">Black</option>
          <option value="brown">Brown</option>
          <option value="gray">Gray</option>
          <option value="orange">Orange</option>
          <option value="golden">Golden</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">üèÉ Action</label>
        <select class="filter-select" id="actionFilter">
          <option value="">Any Action</option>
          <option value="sleeping">Sleeping</option>
          <option value="running">Running</option>
          <option value="playing">Playing</option>
          <option value="eating">Eating</option>
          <option value="sitting">Sitting</option>
          <option value="standing">Standing</option>
          <option value="jumping">Jumping</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">üòä Emotion</label>
        <select class="filter-select" id="emotionFilter">
          <option value="">Any Emotion</option>
          <option value="happy">Happy</option>
          <option value="calm">Calm</option>
          <option value="playful">Playful</option>
          <option value="alert">Alert</option>
          <option value="relaxed">Relaxed</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">üåç Environment</label>
        <select class="filter-select" id="environmentFilter">
          <option value="">Any Environment</option>
          <option value="indoor">Indoor</option>
          <option value="outdoor">Outdoor</option>
          <option value="forest">Forest</option>
          <option value="grassland">Grassland</option>
          <option value="snow">Snow</option>
          <option value="water">Water</option>
          <option value="house">House</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">üí° Lighting</label>
        <select class="filter-select" id="lightingFilter">
          <option value="">Any Lighting</option>
          <option value="daylight">Daylight</option>
          <option value="golden hour">Golden Hour</option>
          <option value="indoor">Indoor Light</option>
          <option value="night">Night</option>
          <option value="natural">Natural Light</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">üì∏ Perspective</label>
        <select class="filter-select" id="perspectiveFilter">
          <option value="">Any Perspective</option>
          <option value="close-up">Close-up</option>
          <option value="full body">Full Body</option>
          <option value="portrait">Portrait</option>
          <option value="wide shot">Wide Shot</option>
        </select>
      </div>
    </div>

    <div class="active-filters" id="activeFilters" style="display: none;">
      <strong style="width: 100%; color: #666;">Active Filters:</strong>
    </div>

    <button onclick="advancedSearch()" 
            style="width: 100%; margin-top: 30px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
      üîç Search with Filters
    </button>

    <button onclick="clearFilters()" 
            style="width: 100%; margin-top: 10px; padding: 12px; background: #f0f0f0; color: #666; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
      Clear All Filters
    </button>
  </div>

  <div id="loading" class="loading" style="display:none">
    <div class="spinner"></div>
    <p>Searching...</p>
  </div>

  <div id="resultsInfo" class="results-info"></div>
  <div id="results" class="results-grid"></div>

  <script>
    const API_BASE = "http://localhost:8000";
    const session_id = "session-" + Math.random().toString(36).substring(2, 9);

    // Update active filters display
    document.querySelectorAll('.filter-select').forEach(select => {
      select.addEventListener('change', updateActiveFilters);
    });

    function updateActiveFilters() {
      const activeFiltersContainer = document.getElementById('activeFilters');
      const filters = getActiveFilters();
      
      if (Object.keys(filters).length === 0) {
        activeFiltersContainer.style.display = 'none';
        return;
      }

      activeFiltersContainer.style.display = 'flex';
      const filterTags = Object.entries(filters).map(([key, value]) => {
        const label = document.querySelector(`#${key}Filter`).previousElementSibling.textContent;
        return `
          <div class="filter-tag">
            ${label}: ${value}
            <span class="remove" onclick="removeFilter('${key}')">√ó</span>
          </div>
        `;
      }).join('');

      activeFiltersContainer.innerHTML = '<strong style="width: 100%; color: #666;">Active Filters:</strong>' + filterTags;
    }

    function getActiveFilters() {
      const filters = {};
      ['species', 'age', 'color', 'action', 'emotion', 'environment', 'lighting', 'perspective'].forEach(key => {
        const value = document.getElementById(key + 'Filter').value;
        if (value) filters[key] = value;
      });
      return filters;
    }

    function removeFilter(key) {
      document.getElementById(key + 'Filter').value = '';
      updateActiveFilters();
    }

    function clearFilters() {
      document.querySelectorAll('.filter-select').forEach(select => select.value = '');
      updateActiveFilters();
    }

    async function advancedSearch() {
      const query = document.getElementById('queryInput').value.trim();
      const filters = getActiveFilters();

      if (!query && Object.keys(filters).length === 0) {
        return alert('Please enter a query or select at least one filter');
      }

      document.getElementById('loading').style.display = 'flex';

      try {
        // Build query text with filters
        let fullQuery = query;
        if (Object.keys(filters).length > 0) {
          const filterText = Object.values(filters).join(' ');
          fullQuery = query ? `${query} ${filterText}` : filterText;
        }

        const res = await fetch(`${API_BASE}/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id,
            query_text: fullQuery,
            top_k: 20
          })
        });

        if (!res.ok) throw new Error('Search failed');
        const data = await res.json();

        // Client-side filter results by metadata
        let filteredResults = data.results;
        if (Object.keys(filters).length > 0) {
          filteredResults = data.results.filter(item => {
            const extra = item.meta.extra ? JSON.parse(item.meta.extra) : {};
            
            for (const [key, value] of Object.entries(filters)) {
              const metadataKey = key === 'color' ? 'color_primary' : 
                                  key === 'age' ? 'age_group' : key;
              const metadataValue = extra[`What ${metadataKey}...`] || extra[Object.keys(extra).find(k => k.includes(metadataKey))] || '';
              
              if (!metadataValue.toLowerCase().includes(value.toLowerCase())) {
                return false;
              }
            }
            return true;
          });
        }

        renderResults(filteredResults, fullQuery);
      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    function renderResults(results, query) {
      const container = document.getElementById('results');
      const info = document.getElementById('resultsInfo');
      
      container.innerHTML = '';
      info.innerHTML = `Found <strong>${results.length}</strong> results for: "${query}"`;

      if (results.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:white;font-size:1.2rem;margin-top:40px;">No results found. Try adjusting your filters.</p>';
        return;
      }

      results.forEach(item => {
        const card = document.createElement('div');
        card.className = 'image-card';
        
        const img = document.createElement('img');
        img.src = item.meta?.file || '';
        img.alt = item.meta?.species || 'Animal';
        img.loading = 'lazy';
        
        const cardInfo = document.createElement('div');
        cardInfo.className = 'card-info';
        cardInfo.innerHTML = `
          <span class="species">${item.meta?.species || 'Unknown'}</span>
          <span class="score">${(item.score * 100).toFixed(1)}%</span>
        `;
        
        card.appendChild(img);
        card.appendChild(cardInfo);
        container.appendChild(card);
      });
    }

    // Enter key to search
    document.getElementById('queryInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') advancedSearch();
    });
  </script>
</body>
</html>
